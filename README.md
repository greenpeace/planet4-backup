# Greenpeace Planet4 Backup Docker Container

![Planet4](./planet4.png)

## Introduction

### What is it?
This repository contains the scripts tha create a docker container which performs backup of images and SQL of the Planet4 websites. 


## How to build it

### In circleCI
Any git commit will create a new version of the docker image, tagged with the circleCI build number and "latest".

The docker image that gets build will then be pushed to the docker hub repository: [greenpeaceinternational/planet4-backup](https://hub.docker.com/r/greenpeaceinternational/planet4-backup) 

### Locally
Run `make build`


## How it works
In Planet4 site repositories there is a circleCI job called "backup". 
It uses the docker image that is generated by this repository. 

When this is called the following things happen: 
   - If they don't already exist, google cloud storage buckets get created. 
   Their naming follows the following convention where WP_STATELESS_BUCKET is the name of the bucket where 
   images are stored in the production site, and can be seen in the circleCI config file of that site. 
    
      - WP_STATELESS_BUCKET + _images_backup  for backing up the images 
      - WP_STATELESS_BUCKET + _db_backup  for backing up the database
     
     The database storage bucket is created with versioning enabled, keeping 365 versions of the file. 
     This allows us to not having to differentiate the files by name, and not to have to worry about rotation 
     schedules
     
     Additionally we enable versioning on the original images bucket if it is not already enabled.

  - A script runs that creates an SQL dump (using mysqldump), zips it, and then uploads it to the bucket
  
  - A script runs that syncs the images from the production to the backup bucket.

## How to access the backed up data
The database files are available as per the google cloud storage [versioning documentation](https://cloud.google.com/storage/docs/using-object-versioning)
    ``` 
    Append the generation number of the archived object to the object name by replacing the [VALUES_IN_BRACKETS] with appropriate values:
    
    [OBJECT_NAME]#[GENERATION_NUMBER]
    
    
    Copying archived object versions
    
    To copy an archived version of an object:
    gsutilREST APIs
    
    Use the gsutil cp command, replacing [VALUES_IN_BRACKETS] with the appropriate values:
    
    gsutil cp gs://[SOURCE_BUCKET_NAME]/[SOURCE_OBJECT_NAME]#[GENERATION_NUMBER] destination_file
    
    ```  

The image files are accessible in the created storage bucket. 

One note about the images file: The above backup safeguards against accidental deletion of the whole produciton storage
bucket. It does not safeguard against deliberate deletion (by the user) of a signle image. This is taken care
by the versioning in the original bucket where images will stay as archived.


## Contribute

Please read the [Contribution Guidelines](https://planet4.greenpeace.org/handbook/dev-contribute-to-planet4/) for Planet4.
